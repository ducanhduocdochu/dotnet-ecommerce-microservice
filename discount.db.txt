-- ============================================
-- DISCOUNT SERVICE DATABASE SCHEMA
-- ============================================
-- Database: discount_db (PostgreSQL)
-- Service: Discount & Promotion Management
-- Port: 5006
-- ============================================

-- ============================================
-- TABLES
-- ============================================

-- 1. Discounts (Mã giảm giá / Coupon)
CREATE TABLE discounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(50) UNIQUE NOT NULL,               -- SALE10, NEWYEAR2024
    name VARCHAR(255) NOT NULL,
    description TEXT,
    
    -- Discount Type
    type VARCHAR(50) NOT NULL,                      -- PERCENTAGE, FIXED_AMOUNT, FREE_SHIPPING, BUY_X_GET_Y
    
    -- Discount Value
    value DECIMAL(15,2) NOT NULL,                   -- 10 (for 10%), 50000 (for 50k off)
    max_discount_amount DECIMAL(15,2),              -- Giảm tối đa (for PERCENTAGE)
    
    -- Minimum Requirements
    min_order_amount DECIMAL(15,2) DEFAULT 0,       -- Đơn tối thiểu
    min_quantity INT DEFAULT 0,                     -- Số lượng sản phẩm tối thiểu
    
    -- Buy X Get Y (for BUY_X_GET_Y type)
    buy_quantity INT,                               -- Mua X
    get_quantity INT,                               -- Tặng Y
    get_discount_percent DECIMAL(5,2),              -- Giảm % cho Y (100 = free)
    
    -- Usage Limits
    usage_limit INT,                                -- Tổng số lần sử dụng tối đa
    usage_limit_per_user INT DEFAULT 1,             -- Số lần mỗi user được dùng
    usage_count INT DEFAULT 0,                      -- Đã sử dụng
    
    -- Validity
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP NOT NULL,
    
    -- Scope
    scope VARCHAR(50) DEFAULT 'ALL',                -- ALL, SPECIFIC_PRODUCTS, SPECIFIC_CATEGORIES, SPECIFIC_USERS
    
    -- Status
    is_active BOOLEAN DEFAULT TRUE,
    is_public BOOLEAN DEFAULT TRUE,                 -- Hiển thị public hay chỉ nhập code
    
    -- Priority (for stacking rules)
    priority INT DEFAULT 0,                         -- Ưu tiên cao hơn apply trước
    is_stackable BOOLEAN DEFAULT FALSE,             -- Có thể dùng chung với mã khác
    
    -- Created by
    created_by UUID,
    created_by_name VARCHAR(255),
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_discounts_code ON discounts(code);
CREATE INDEX idx_discounts_type ON discounts(type);
CREATE INDEX idx_discounts_active ON discounts(is_active) WHERE is_active = TRUE;
CREATE INDEX idx_discounts_dates ON discounts(start_date, end_date);

-- 2. Discount Products (Sản phẩm áp dụng)
CREATE TABLE discount_products (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    discount_id UUID NOT NULL REFERENCES discounts(id) ON DELETE CASCADE,
    product_id UUID NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(discount_id, product_id)
);

CREATE INDEX idx_discount_products_discount_id ON discount_products(discount_id);
CREATE INDEX idx_discount_products_product_id ON discount_products(product_id);

-- 3. Discount Categories (Danh mục áp dụng)
CREATE TABLE discount_categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    discount_id UUID NOT NULL REFERENCES discounts(id) ON DELETE CASCADE,
    category_id UUID NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(discount_id, category_id)
);

CREATE INDEX idx_discount_categories_discount_id ON discount_categories(discount_id);

-- 4. Discount Users (User được áp dụng - VIP, specific users)
CREATE TABLE discount_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    discount_id UUID NOT NULL REFERENCES discounts(id) ON DELETE CASCADE,
    user_id UUID NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(discount_id, user_id)
);

CREATE INDEX idx_discount_users_discount_id ON discount_users(discount_id);
CREATE INDEX idx_discount_users_user_id ON discount_users(user_id);

-- 5. Discount Usage (Lịch sử sử dụng)
CREATE TABLE discount_usages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    discount_id UUID NOT NULL REFERENCES discounts(id),
    user_id UUID NOT NULL,
    order_id UUID NOT NULL,
    order_number VARCHAR(50),
    
    -- Amount
    order_amount DECIMAL(15,2) NOT NULL,            -- Giá trị đơn hàng
    discount_amount DECIMAL(15,2) NOT NULL,         -- Số tiền được giảm
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_discount_usages_discount_id ON discount_usages(discount_id);
CREATE INDEX idx_discount_usages_user_id ON discount_usages(user_id);
CREATE INDEX idx_discount_usages_order_id ON discount_usages(order_id);

-- 6. Promotions (Chương trình khuyến mãi lớn)
CREATE TABLE promotions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(50) UNIQUE NOT NULL,               -- BLACKFRIDAY, FLASH_SALE
    name VARCHAR(255) NOT NULL,
    description TEXT,
    
    -- Banner
    banner_url TEXT,
    thumbnail_url TEXT,
    
    -- Validity
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP NOT NULL,
    
    -- Status
    is_active BOOLEAN DEFAULT TRUE,
    is_featured BOOLEAN DEFAULT FALSE,
    
    -- Display
    display_order INT DEFAULT 0,
    
    created_by UUID,
    created_by_name VARCHAR(255),
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_promotions_active ON promotions(is_active, start_date, end_date);

-- 7. Promotion Discounts (Mã giảm giá thuộc promotion)
CREATE TABLE promotion_discounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    promotion_id UUID NOT NULL REFERENCES promotions(id) ON DELETE CASCADE,
    discount_id UUID NOT NULL REFERENCES discounts(id) ON DELETE CASCADE,
    display_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(promotion_id, discount_id)
);

-- 8. Flash Sales (Giảm giá chớp nhoáng)
CREATE TABLE flash_sales (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    
    -- Timing
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
    
    -- Status
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 9. Flash Sale Items
CREATE TABLE flash_sale_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    flash_sale_id UUID NOT NULL REFERENCES flash_sales(id) ON DELETE CASCADE,
    
    product_id UUID NOT NULL,
    variant_id UUID,
    
    -- Pricing
    original_price DECIMAL(15,2) NOT NULL,
    sale_price DECIMAL(15,2) NOT NULL,
    discount_percent DECIMAL(5,2),                  -- Tính từ original vs sale
    
    -- Quantity
    quantity_limit INT NOT NULL,                    -- Số lượng flash sale
    quantity_sold INT DEFAULT 0,
    
    -- Per user limit
    limit_per_user INT DEFAULT 1,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(flash_sale_id, product_id, variant_id)
);

CREATE INDEX idx_flash_sale_items_flash_sale ON flash_sale_items(flash_sale_id);
CREATE INDEX idx_flash_sale_items_product ON flash_sale_items(product_id);

-- ============================================
-- DISCOUNT TYPES
-- ============================================
--
-- | Type           | Value Example | Description                    |
-- |----------------|---------------|--------------------------------|
-- | PERCENTAGE     | 10            | Giảm 10%                       |
-- | FIXED_AMOUNT   | 50000         | Giảm 50,000đ                   |
-- | FREE_SHIPPING  | 0             | Miễn phí ship                  |
-- | BUY_X_GET_Y    | 100           | Mua X tặng Y (giảm 100% cho Y) |
--
-- ============================================

-- ============================================
-- DISCOUNT SCOPE
-- ============================================
--
-- | Scope               | Description                          |
-- |---------------------|--------------------------------------|
-- | ALL                 | Áp dụng cho tất cả sản phẩm         |
-- | SPECIFIC_PRODUCTS   | Chỉ áp dụng cho sản phẩm cụ thể     |
-- | SPECIFIC_CATEGORIES | Chỉ áp dụng cho danh mục cụ thể     |
-- | SPECIFIC_USERS      | Chỉ áp dụng cho user cụ thể (VIP)   |
--
-- ============================================

-- ============================================
-- VALIDATION FLOW
-- ============================================
--
-- 1. Check if discount exists and is_active
-- 2. Check date validity (start_date <= now <= end_date)
-- 3. Check usage_limit (usage_count < usage_limit)
-- 4. Check usage_limit_per_user
-- 5. Check min_order_amount
-- 6. Check min_quantity
-- 7. Check scope (products/categories/users)
-- 8. Calculate discount_amount
-- 9. Apply max_discount_amount cap
--
-- ============================================

-- ============================================
-- SEED DATA
-- ============================================

INSERT INTO discounts (code, name, type, value, min_order_amount, usage_limit, start_date, end_date, is_public) VALUES
    ('WELCOME10', 'Giảm 10% cho khách mới', 'PERCENTAGE', 10, 100000, 1000, NOW(), NOW() + INTERVAL '1 year', TRUE),
    ('FREESHIP', 'Miễn phí vận chuyển', 'FREE_SHIPPING', 0, 200000, NULL, NOW(), NOW() + INTERVAL '1 year', TRUE),
    ('SALE50K', 'Giảm 50K cho đơn từ 500K', 'FIXED_AMOUNT', 50000, 500000, 500, NOW(), NOW() + INTERVAL '3 months', TRUE);

